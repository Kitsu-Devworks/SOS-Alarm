<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DUNGEON RAID | RETRO EDITION</title>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --retro-pink: #ff00ff; --retro-cyan: #00ffff; --retro-yellow: #ffff00; 
            --bg-dark: #120458; --panel-bg: #2d025d;
        }

        body { 
            font-family: 'Press Start 2P', cursive; 
            background-color: var(--bg-dark);
            background-image: linear-gradient(rgba(18, 4, 88, 1) 50%, rgba(0, 0, 0, 0.2) 50%),
                              linear-gradient(90deg, rgba(255, 0, 0, 0.05), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.05));
            background-size: 100% 4px, 3px 100%;
            height: 100vh; margin: 0; overflow: hidden; display: flex; align-items: center; justify-content: center;
        }

        /* Efecto de parpadeo de pantalla vieja */
        body::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: rgba(18, 16, 16, 0.1); opacity: 0; z-index: 2; pointer-events: none;
            animation: flicker 0.15s infinite;
        }
        @keyframes flicker { 0% { opacity: 0.273; } 100% { opacity: 0.111; } }

        .arcade-cabinet {
            width: 460px; background: #000; border: 4px solid #fff;
            box-shadow: 10px 10px 0px var(--retro-pink), -10px -10px 0px var(--retro-cyan);
            padding: 20px; position: relative; display: flex; flex-direction: column; gap: 15px;
        }

        .screen-title {
            color: var(--retro-yellow); text-shadow: 4px 4px 0px #ff0000;
            font-size: 14px; text-align: center; margin-bottom: 10px; line-height: 1.5;
        }

        .retro-input {
            background: #000; border: 3px solid var(--retro-cyan); color: #fff;
            font-family: 'Press Start 2P'; font-size: 10px; padding: 10px; width: 80%;
            margin: 0 auto; display: block; outline: none; text-align: center;
        }

        /* Botones estilo Arcade */
        .btn-grid { display: flex; justify-content: space-around; margin: 20px 0; }
        .btn-raid {
            width: 80px; height: 80px; border: 4px solid #000; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.1s; position: relative; opacity: 0.3; filter: grayscale(1);
        }
        .btn-raid:active { transform: translateY(4px); }
        .enabled { opacity: 1 !important; filter: grayscale(0) !important; }

        .btn-easy { background: #00ff00; box-shadow: 0 6px 0 #008800; }
        .btn-medium { background: #ffff00; box-shadow: 0 6px 0 #888800; }
        .btn-hard { background: #ff0000; box-shadow: 0 6px 0 #880000; }

        .btn-way {
            background: var(--retro-cyan); border: 4px solid #000; color: #000;
            font-family: 'Press Start 2P'; font-size: 10px; padding: 15px;
            box-shadow: 0 6px 0 #008888; width: 100%; opacity: 0.3; cursor: pointer;
        }

        /* Log estilo consola retro */
        .retro-log {
            background: #1a1a1a; border: 2px solid #555; height: 120px;
            font-family: 'JetBrains Mono'; font-size: 11px; color: #0f0;
            padding: 10px; overflow-y: auto; text-transform: uppercase;
        }

        /* Volumen Vertical Retro */
        .vol-container { position: absolute; left: -70px; top: 50%; transform: translateY(-50%); text-align: center; }
        .vol-slider-wrap { transform: rotate(-90deg); width: 180px; height: 30px; margin-top: 80px; }
        .retro-slider { -webkit-appearance: none; background: #333; height: 10px; border: 2px solid #fff; width: 180px; }
        .retro-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 15px; height: 25px; background: var(--retro-pink); border: 2px solid #fff; cursor: pointer; }

        /* Online List Right */
        .online-list {
            position: absolute; right: -140px; top: 20px; width: 120px;
            background: #000; border: 2px solid var(--retro-yellow);
            padding: 10px; font-size: 8px; color: var(--retro-yellow);
        }

        #timer-display { color: #ff0000; font-size: 20px; text-align: center; display: none; margin: 10px 0; }
        .fixed-logo { position: fixed; bottom: 10px; right: 10px; width: 90px; image-rendering: pixelated; }
    </style>
</head>
<body>

    <img src="KitsuLogo2.png" alt="Logo" class="fixed-logo">

    <div class="relative">
        <div class="vol-container">
            <div id="volLabel" style="font-size: 8px; color:#fff; margin-bottom: 50px;">VOL:50%</div>
            <div class="vol-slider-wrap">
                <input type="range" id="volControl" class="retro-slider" min="0" max="1" step="0.01" value="0.5">
            </div>
        </div>

        <div class="arcade-cabinet">
            <div class="screen-title">KITSU DEVWORKS<br>--- DUNGEON RAID ---</div>
            
            <input type="text" id="userName" placeholder="INSERT NICK" maxlength="8" class="retro-input">

            <div class="btn-grid">
                <button id="easyBtn" class="btn-raid btn-easy">
                    <span style="font-size:20px">üõ°Ô∏è</span>
                    <span style="font-size:7px; color:#000; font-weight:bold; margin-top:5px">EASY</span>
                </button>
                <button id="medBtn" class="btn-raid btn-medium">
                    <span style="font-size:20px">‚öîÔ∏è</span>
                    <span style="font-size:7px; color:#000; font-weight:bold; margin-top:5px">MED</span>
                </button>
                <button id="hardBtn" class="btn-raid btn-hard">
                    <span style="font-size:20px">üíÄ</span>
                    <span style="font-size:7px; color:#000; font-weight:bold; margin-top:5px">HARD</span>
                </button>
            </div>

            <button id="wayBtn" class="btn-way">RUN TO DUNGEON</button>

            <div id="timer-display">WAIT: <span id="timer-count">30</span>S</div>

            <div id="log" class="retro-log">> SYSTEM READY...</div>
            
            <div style="font-size: 7px; text-align: center; color: #555;">VER 6.5 - INSERT COIN</div>
        </div>

        <div class="online-list">
            <div style="border-bottom: 1px solid #ffff00; margin-bottom: 5px; padding-bottom: 5px;">PLAYERS: <span id="userCount">0</span></div>
            <div id="userList"></div>
        </div>
    </div>

    <script>
        const PUSHER_KEY = '78831e6e7f703ddd4fb2';
        const CLOUDFLARE_URL = 'https://dungeon-sos.kitsu-devworks.workers.dev';

        const nameField = document.getElementById('userName');
        const diffButtons = document.querySelectorAll('.btn-raid');
        const wayBtn = document.getElementById('wayBtn');
        const timerDisplay = document.getElementById('timer-display');
        const timerCount = document.getElementById('timer-count');
        const volControl = document.getElementById('volControl');
        
        const soundUrls = { 
            EASY: "https://assets.mixkit.co/active_storage/sfx/2567/2567-preview.mp3", 
            MEDIUM: "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3", 
            HARD: "https://assets.mixkit.co/active_storage/sfx/2573/2573-preview.mp3", 
            WAY: "https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" 
        };
        
        let countdown, isTimerActive = false, hasConfirmedWay = false, onlineUsers = {};

        function playAlert(type) {
            const url = soundUrls[type];
            if (!url) return;
            const audio = new Audio(url);
            audio.volume = parseFloat(volControl.value);
            audio.play().catch(e => console.log("Play blocked"));
        }

        function updateUI() {
            const hasName = nameField.value.trim().length >= 2;
            if (!hasName) {
                diffButtons.forEach(b => b.classList.remove('enabled'));
                wayBtn.classList.remove('enabled');
                return;
            }
            if (isTimerActive) {
                diffButtons.forEach(b => b.classList.remove('enabled'));
                (!hasConfirmedWay) ? wayBtn.classList.add('enabled') : wayBtn.classList.remove('enabled');
            } else {
                diffButtons.forEach(b => b.classList.add('enabled'));
                wayBtn.classList.remove('enabled');
            }
        }

        function renderOnline() {
            const now = Date.now();
            let html = '', count = 0;
            for (let u in onlineUsers) {
                if (now - onlineUsers[u] > 20000) { delete onlineUsers[u]; continue; }
                html += `<div style="margin-bottom:4px">_ ${u}</div>`;
                count++;
            }
            document.getElementById('userList').innerHTML = html;
            document.getElementById('userCount').innerText = count;
        }

        const pusher = new Pusher(PUSHER_KEY, { cluster: 'us2', forceTLS: true });
        const channel = pusher.subscribe('dungeon-channel');

        channel.bind('client-sos', (data) => {
            const [name, type] = data.user.split('|');
            onlineUsers[name.toUpperCase()] = Date.now(); 
            renderOnline();
            if (type === 'PULSE') return;
            
            playAlert(type);
            const colors = { EASY: '#0f0', MEDIUM: '#ff0', HARD: '#f00', WAY: '#0ff' };

            if (type !== 'WAY') {
                startTimer();
                addLog(`${name} SOS: ${type}`, colors[type]);
            } else {
                addLog(`${name} ON WAY!`, colors.WAY);
            }
        });

        async function sendSignal(type) {
            const user = nameField.value.trim();
            if (!user || user.length < 2) return;
            if (type === 'WAY') { hasConfirmedWay = true; updateUI(); }
            try {
                await fetch(CLOUDFLARE_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ user: `${user.toUpperCase()}|${type}` }) });
            } catch (e) {}
        }

        function startTimer() {
            clearInterval(countdown);
            isTimerActive = true; hasConfirmedWay = false; updateUI();
            let s = 30;
            timerDisplay.style.display = 'block';
            timerCount.innerText = s;
            countdown = setInterval(() => {
                s--;
                timerCount.innerText = s;
                if (s <= 0) {
                    clearInterval(countdown);
                    isTimerActive = false;
                    timerDisplay.style.display = 'none';
                    updateUI();
                }
            }, 1000);
        }

        function addLog(msg, color) {
            const log = document.getElementById('log');
            log.innerHTML = `<div style="color:${color}">> ${msg}</div>` + log.innerHTML;
        }

        volControl.oninput = (e) => {
            document.getElementById('volLabel').innerText = "VOL:" + Math.round(e.target.value * 100) + "%";
        };

        setInterval(() => { if (nameField.value.trim().length >= 2) sendSignal('PULSE'); }, 10000);
        setInterval(renderOnline, 5000);
        nameField.addEventListener('input', updateUI);
        document.getElementById('easyBtn').onclick = () => sendSignal('EASY');
        document.getElementById('medBtn').onclick = () => sendSignal('MEDIUM');
        document.getElementById('hardBtn').onclick = () => sendSignal('HARD');
        document.getElementById('wayBtn').onclick = () => sendSignal('WAY');
    </script>
</body>
</html>
